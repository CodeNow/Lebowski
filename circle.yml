machine:
  environment:
    NODE_ENV: testing
dependencies:
  override:
    - npm install
    - pip install fabric
    - 'echo "$CIRCLE_BRANCH" | grep -q -w -P "(.*chef.*)|(master)" && (bundle check --path=vendor/bundle || bundle install --path=vendor/bundle  --clean) || true':
        pwd: cookbook
        timeout: 99999
    - 'echo "$CIRCLE_BRANCH" | grep -q -w -P "(.*chef.*)|(master)" && (bundle exec berks install) || true ':
        pwd: cookbook
test:
  override:
    - npm test
    - 'echo "$CIRCLE_BRANCH" | grep -q -w -P "(.*chef.*)|(master)" && (bundle exec rake test) || true':
        pwd: cookbook
        timeout: 99999
  post:
    - cp cookbook/.kitchen/logs/* $CIRCLE_ARTIFACTS

